<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Search Results | RentoVerse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in-up { 0%{transform:translateY(12px);opacity:0} 100%{transform:translateY(0);opacity:1} }
        .animate-fade-in-up{ animation: fade-in-up .35s ease-out forwards; }
        .skeleton{ background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 37%,#e5e7eb 63%); background-size:400% 100%; animation:shimmer 1.2s infinite }
        @keyframes shimmer{ 0%{background-position:100% 0} 100%{background-position:0 0} }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-100 via-sky-100 to-purple-100 text-slate-900">

<!-- Navbar -->
<header class="fixed inset-x-0 top-0 z-50 bg-white/95 backdrop-blur shadow">
    <nav class="mx-auto max-w-7xl px-4">
        <div class="flex h-14 items-center justify-between">
            <a href="/index.html" class="inline-flex items-center gap-2 font-extrabold text-indigo-700">
                <img src="https://img.icons8.com/fluency/48/home.png" alt="Home" class="w-5 h-5"/>
                <span>RentoVerse</span>
            </a>
            <a href="/index.html" class="text-sm font-medium text-indigo-700 hover:text-indigo-900">‚Üê Back to Home</a>
        </div>
    </nav>
</header>

<main class="pt-20">
    <!-- Hero -->
    <section class="mx-auto max-w-7xl px-4">
        <div class="rounded-2xl bg-white/75 backdrop-blur ring-1 ring-white/50 shadow-sm p-6 md:p-8">
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">üîé Search Results</h1>
            <p id="queryLine" class="mt-1 text-slate-600 text-sm md:text-base">Looking for rooms‚Ä¶</p>
        </div>
    </section>

    <!-- Results -->
    <section class="mx-auto max-w-7xl px-4">
        <div id="results" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-7 md:gap-8">
            <!-- Loading skeletons -->
            <article class="rounded-2xl overflow-hidden bg-white shadow ring-1 ring-slate-200">
                <div class="h-44 skeleton"></div>
                <div class="p-4 space-y-3">
                    <div class="h-5 w-2/3 rounded skeleton"></div>
                    <div class="h-4 w-1/2 rounded skeleton"></div>
                    <div class="h-4 w-1/3 rounded skeleton"></div>
                </div>
            </article>
            <article class="rounded-2xl overflow-hidden bg-white shadow ring-1 ring-slate-200 hidden sm:block">
                <div class="h-44 skeleton"></div>
                <div class="p-4 space-y-3">
                    <div class="h-5 w-2/3 rounded skeleton"></div>
                    <div class="h-4 w-1/2 rounded skeleton"></div>
                    <div class="h-4 w-1/3 rounded skeleton"></div>
                </div>
            </article>
            <article class="rounded-2xl overflow-hidden bg-white shadow ring-1 ring-slate-200 hidden lg:block">
                <div class="h-44 skeleton"></div>
                <div class="p-4 space-y-3">
                    <div class="h-5 w-2/3 rounded skeleton"></div>
                    <div class="h-4 w-1/2 rounded skeleton"></div>
                    <div class="h-4 w-1/3 rounded skeleton"></div>
                </div>
            </article>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="hidden mt-10 rounded-2xl bg-white shadow ring-1 ring-slate-200 p-10 text-center">
            <div class="mx-auto w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                <span class="text-xl">üß≠</span>
            </div>
            <h2 class="mt-4 text-xl font-extrabold">No rooms found</h2>
            <p class="mt-1 text-slate-600">Try a nearby location or clear filters.</p>
            <a href="/index.html"
               class="inline-block mt-4 rounded-lg bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-indigo-700 transition">
                Go back & search again
            </a>
        </div>
    </section>
</main>

<!-- Toasts -->
<div id="toast-container" class="fixed top-20 right-5 z-50 space-y-2"></div>

<!-- Single, final script (no duplicates) -->
<script>
    // ---------- API base resolution ----------
    (function initApiBase() {
        const origin = window.location.origin;
        const isLocal =
            origin.startsWith("http://localhost") ||
            origin.startsWith("http://127.") ||
            origin === "null" ||
            origin.startsWith("file:");
        const DEFAULT_REMOTE = "https://rentoverse-backend.onrender.com"; // <- your backend URL
        window.API_BASE = isLocal
            ? (localStorage.getItem("API_BASE") || DEFAULT_REMOTE)
            : origin;
    })();

    // Toast helper
    function showToast(message, color = "bg-red-500") {
        let root = document.getElementById("toast-container");
        if (!root) {
            root = document.createElement("div");
            root.id = "toast-container";
            root.className = "fixed top-20 right-5 z-50 space-y-2";
            document.body.appendChild(root);
        }
        const toast = document.createElement("div");
        toast.className = `${color} text-white px-4 py-2 rounded shadow-md animate-fade-in-up mt-2`;
        toast.innerText = message;
        root.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Prefer original text; fallback to lowercased legacy key
        const storedOriginal = localStorage.getItem("searchLocationOriginal") || "";
        const storedLower    = localStorage.getItem("searchLocation") || "";
        const loc = (storedOriginal || storedLower).trim();

        const queryLine  = document.getElementById("queryLine");
        const container  = document.getElementById("results");
        const emptyState = document.getElementById("emptyState");

        if (!loc) {
            queryLine.textContent = "No search location provided.";
            container.classList.add("hidden");
            emptyState.classList.remove("hidden");
            emptyState.querySelector("h2").textContent = "No search location provided";
            emptyState.querySelector("p").textContent = "Please start a new search from the home page.";
            return;
        }

        queryLine.textContent = `Showing results for "${loc}"`;

        // Primary call: /filter; if fails, fallback: /available + client-side match
        loadFilter(loc)
            .then(renderList)
            .catch(async (e) => {
                console.warn("filter failed, trying available:", e?.message || e);
                try {
                    const list = await loadAvailableAndClientFilter(loc);
                    renderList(list);
                } catch (e2) {
                    console.error(e2);
                    container.innerHTML = "<p class='text-red-600'>Error loading search results.</p>";
                }
            });

        // ---- helpers ----
        async function loadFilter(location) {
            const url = `${window.API_BASE}/api/rooms/filter?location=${encodeURIComponent(location)}&type=`;
            const res = await fetch(url);
            if (!res.ok) throw new Error((await tryText(res)) || `HTTP ${res.status}`);
            const text = await tryText(res);
            return text ? JSON.parse(text) : [];
        }

        async function loadAvailableAndClientFilter(location) {
            const res = await fetch(`${window.API_BASE}/api/rooms/available`);
            if (!res.ok) throw new Error((await tryText(res)) || `HTTP ${res.status}`);
            const list = await res.json().catch(() => []);
            const needle = location.toLowerCase();
            return list.filter(r => (r.location || "").toLowerCase().includes(needle));
        }

        async function tryText(res) {
            try { return await res.text(); } catch { return ""; }
        }

        function absoluteImg(url) {
            if (!url) return "https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop";
            if (url.startsWith("http")) return url;
            return `${window.API_BASE}${url}`; // <- IMPORTANT when FE/BE on different domains
        }

        function renderList(data) {
            container.innerHTML = ""; // clear skeletons

            if (!Array.isArray(data) || data.length === 0) {
                emptyState.classList.remove("hidden");
                return;
            }

            data.forEach(room => {
                const img   = absoluteImg(room.imageUrl);
                const title = room.title || "Untitled Room";
                const rent  = room.rent != null ? room.rent : "N/A";
                const locTx = room.location || "‚Äî";
                const type  = room.type || "";
                const desc  = room.description || "‚Äî";

                const card = document.createElement("article");
                card.className = "bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-lg transition ring-1 ring-slate-200 animate-fade-in-up";

                card.innerHTML = `
          <div class="relative">
            <img src="${img}" alt="${title}" class="w-full h-44 md:h-48 object-cover"
                 onerror="this.src='https://via.placeholder.com/640x360?text=Room'; this.onerror=null;">
            ${type ? '<span class="absolute top-3 left-3 rounded-full bg-white/90 text-slate-800 text-xs font-semibold px-3 py-1 ring-1 ring-slate-200">' + type + '</span>' : ''}
          </div>
          <div class="p-4">
            <h2 class="font-extrabold text-lg text-slate-900 leading-snug">${title}</h2>
            <p class="text-slate-600 text-sm mt-0.5">üìç ${locTx}</p>
            <p class="text-slate-700 text-sm mt-1">${desc}</p>
            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="text-slate-900 font-bold whitespace-nowrap">‡ß≥ ${rent} <span class="text-slate-500 font-medium">/ month</span></div>
              <button class="request-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1.5 px-3 rounded w-full sm:w-auto">
                Request
              </button>
            </div>
          </div>
        `;

                const btn = card.querySelector(".request-btn");
                btn.addEventListener("click", () => {
                    const renterEmail = localStorage.getItem("email");
                    const role = localStorage.getItem("role");

                    if (!renterEmail || !role) {
                        showToast("Please login as a renter to request a room.");
                        return;
                    }
                    if (role !== "RENTER") {
                        showToast("Only renters can request a room.");
                        return;
                    }

                    btn.disabled = true;
                    btn.classList.add("opacity-60","cursor-not-allowed");

                    fetch(`${window.API_BASE}/api/bookings/request`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ renterEmail, roomId: room.id })
                    })
                        .then(res => {
                            if (!res.ok) throw new Error("Request failed");
                            return res.text();
                        })
                        .then(() => showToast("‚úÖ Booking request sent!", "bg-green-600"))
                        .catch(err => showToast("‚ùå Error: " + (err.message || "Failed")))
                        .finally(() => {
                            btn.disabled = false;
                            btn.classList.remove("opacity-60","cursor-not-allowed");
                        });
                });

                container.appendChild(card);
            });
        }
    });
</script>
</body>
</html>
